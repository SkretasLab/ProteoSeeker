#!/bin/bash
set -e

./taxonomy_tests/setup.sh

K_8_PATH="${HDD_PATH}/sample_X/sample_X_kraken_8"
M_NR_PATH="${PS_PATH}/results/sample_X/sample_X_metabinner_nr"

if [ ! -d "${PS_PATH}/results/sample_X" ]; then
  mkdir "${PS_PATH}/results/sample_X"
fi

if [ ! -d "${HDD_PATH}/sample_X/" ]; then
  mkdir "${HDD_PATH}/sample_X/"
fi

# Datbase: nr
if [ -d "${K_8_PATH}" ]; then
  if [ ! -d "${M_NR_PATH}" ]; then
    mkdir "${M_NR_PATH}"
    mkdir "${M_NR_PATH}/contigs"
  fi
  cp "${K_8_PATH}/log_input.txt" "${M_NR_PATH}"
  cp "${K_8_PATH}/log_output.txt" "${M_NR_PATH}"
  cp "${K_8_PATH}/identified_adapters.fa" "${M_NR_PATH}"
  cp "${K_8_PATH}/read_information.txt" "${M_NR_PATH}"
  cp -r "${K_8_PATH}/summaries_errors" "${M_NR_PATH}"
  cp -r "${K_8_PATH}/fastqc_results" "${M_NR_PATH}"
  cp -r "${K_8_PATH}/trimmed_results" "${M_NR_PATH}"
  cp -r "${K_8_PATH}/megahit_results" "${M_NR_PATH}"
  cp -r "${K_8_PATH}/gene_results" "${M_NR_PATH}"

  # Contigs
  cp "${K_8_PATH}/contigs/contigs.fa" "${M_NR_PATH}/contigs"
  cp "${K_8_PATH}/contigs/contigs_formated.fna" "${M_NR_PATH}/contigs"

  # Run nr
  python -u proteoseeker.py -pfp "${PS_PATH}/parameter_files/X/par_sX_phylo_m_nr.txt" &> "${PS_PATH}/results/sample_X/stdoe_sX_mnr.txt"
  
  # Move nr
  mv "${M_NR_PATH}" "${HDD_PATH}/sample_X/"
  mkdir "${M_NR_PATH}"
  mkdir "${M_NR_PATH}/metabinner_results"
  if [ -f "${HDD_PATH}/sample_X/sample_X_metabinner_nr/metabinner_results/b_summary_info_metabinner.tsv" ]; then
    cp "${HDD_PATH}/sample_X/sample_X_metabinner_nr/metabinner_results/b_summary_info_metabinner.tsv" "${M_NR_PATH}/metabinner_results/"
  fi
  if [ -f "${HDD_PATH}/sample_X/sample_X_metabinner_nr/time_analysis.tsv" ]; then
    cp "${HDD_PATH}/sample_X/sample_X_metabinner_nr/time_analysis.tsv" "${M_NR_PATH}/metabinner_results/"
  fi
fi
